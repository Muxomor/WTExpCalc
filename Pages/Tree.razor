@page "/tree/{NationId:int}"
@using WTExpCalc.Models
@using WTExpCalc.Services
@using WTExpCalc.Shared
@using static WTExpCalc.Shared.TechTree
@inject IExperienceApi Api
@inject IJSRuntime JSRuntime

<h3>Ветка прокачки для нации @FormattingUtils.FormatNationName(currentNation?.Name, NationId)</h3>
@if (vehicleTypes == null)
{
    <p><em>Загрузка типов…</em></p>
}
else
{
    <ul class="nav nav-tabs">
        @foreach (var vt in vehicleTypes)
        {
            <li class="nav-item">
                <a class="nav-link @(vt.Id == activeTypeId ? "active" : "")"
                   href="#"
                   @onclick="() => SelectType(vt.Id)"
                @onclick:preventDefault>
                    @vt.Name
                </a>
            </li>
        }
    </ul>

    <div class="tab-content mt-3">
        @if (activeTypeId != null)
        {
            <TechTree NationId="NationId" TypeId="activeTypeId.Value" OnTotalsUpdated="HandleTotalsUpdate" />
        }
    </div>
    <div id="summary-container">
        <div id="summary-panel">
            <span class="summary-item summary-rp">
                <span>ОИ:</span> @currentTotalRp.ToString("N0")
            </span>
            <span class="summary-item summary-sl">
                <span>СЛ:</span> @currentTotalSl.ToString("N0")
            </span>
        </div>

        <div id="selected-names-container">
            <div id="selected-names-panel">
                @if (!string.IsNullOrEmpty(selectedVehicleNames))
                {
                    <span title="@selectedVehicleNames">
                        Выбрано: @selectedVehicleNames
                    </span>
                }
                else
                {
                    <span>&nbsp;</span>
                }
            </div>
            @if (!string.IsNullOrEmpty(selectedVehicleNames))
            {
                <button class="btn btn-sm btn-secondary copy-button" title="Копировать список" @onclick="CopyNamesToClipboard">
                    <i class="bi bi-clipboard"></i>
                </button>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int NationId { get; set; }
    private List<VehicleType>? vehicleTypes;
    private int? activeTypeId;
    private Nation? currentNation; 
    private long currentTotalRp = 0;
    private long currentTotalSl = 0;
    private string selectedVehicleNames = "";

    protected override async Task OnParametersSetAsync() 
    {
        vehicleTypes = null;
        currentNation = null;
        activeTypeId = null;
        StateHasChanged(); 

        vehicleTypes = await Api.GetVehicleTypesAsync();
        currentNation = await Api.GetNationByIdAsync(NationId); 

        if (vehicleTypes != null && vehicleTypes.Any())
        {
            activeTypeId = vehicleTypes.First().Id;
            selectedVehicleNames = "";
            currentTotalRp = 0;
            currentTotalSl = 0;
        }
        StateHasChanged(); 
    }
    private async Task CopyNamesToClipboard()
    {
        if (!string.IsNullOrEmpty(selectedVehicleNames))
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("techTreeFunctions.copyTextToClipboard_fallback", selectedVehicleNames);
                Console.WriteLine("Copied names to clipboard.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error copying to clipboard: {ex.Message}");
            }
        }
    }
    private void HandleTotalsUpdate(TotalsUpdateEventArgs args)
    {
        currentTotalRp = args.TotalRp;
        currentTotalSl = args.TotalSl;
        selectedVehicleNames = args.SelectedNames;
    }
    void SelectType(int id)
    {
        activeTypeId = id;
    }
}